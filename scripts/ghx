#!/usr/bin/env bash
set -euo pipefail

if ! command -v gh >/dev/null 2>&1; then
  echo "error: gh is not installed" >&2
  exit 127
fi

if command -v direnv >/dev/null 2>&1; then
  project_root="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
  stderr_file="$(mktemp)"
  trap 'rm -f "$stderr_file"' EXIT
  if direnv exec "$project_root" gh "$@" 2>"$stderr_file"; then
    sed '/direnv: loading /d' "$stderr_file" >&2
    exit 0
  fi
  status=$?
  sed '/direnv: loading /d' "$stderr_file" >&2
  exit "$status"
fi

echo "warning: direnv is not installed; running gh without direnv" >&2
exec gh "$@"
