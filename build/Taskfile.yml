version: '3'

tasks:
  go:mod:tidy:
    summary: Runs `go mod tidy`
    internal: true
    cmds:
      - go mod tidy

  install:frontend:deps:
    summary: Install frontend dependencies
    dir: ../frontend
    sources:
      - package.json
      - bun.lockb
    generates:
      - node_modules/*
    preconditions:
      - sh: bun --version
        msg: "Looks like bun isn't installed. Install from: https://bun.sh/"
    cmds:
      - bun install

  build:web:overlay:
    summary: Build web overlay (OBS用オーバーレイ)
    dir: ../web
    sources:
      - "src/**/*"
      - "public/**/*"
      - "index.html"
      - "package.json"
      - "bun.lockb"
      - "tsconfig*.json"
      - "vite.config.*"
      - exclude: "dist/**/*"
      - exclude: "node_modules/**/*"
    generates:
      - dist/**/*
    cmds:
      - bun run build

  build:frontend:
    label: build:frontend (PRODUCTION={{.PRODUCTION}})
    summary: Build the frontend project
    dir: ../frontend
    sources:
      - "**/*"
    generates:
      - dist/**/*
    deps:
      - task: install:frontend:deps
      - task: generate:bindings
        vars:
          BUILD_FLAGS:
            ref: .BUILD_FLAGS
    cmds:
      - bun run {{.BUILD_COMMAND}}
    env:
      PRODUCTION: '{{.PRODUCTION | default "false"}}'
    vars:
      BUILD_COMMAND: '{{if eq .PRODUCTION "true"}}build{{else}}build:dev{{end}}'

  generate:bindings:
    label: generate:bindings (BUILD_FLAGS={{.BUILD_FLAGS}})
    summary: Generates bindings for the frontend
    deps:
      - task: go:mod:tidy
    sources:
      - "../**/*.[jt]s"
      - exclude: ../frontend/**/*
      - ../frontend/bindings/**/*
      - "../**/*.go"
      - ../go.mod
      - ../go.sum
    generates:
      - ../frontend/bindings/**/*
    cmds:
      - wails3 generate bindings -f '{{.BUILD_FLAGS}}' -clean=true

  generate:icons:
    summary: Generates Windows `.ico` and Mac `.icns` files from an image
    sources:
      - "appicon.png"
    generates:
      - "darwin/icons.icns"
      - "windows/icon.ico"
    cmds:
      - wails3 generate icons -input appicon.png -macfilename darwin/icons.icns -windowsfilename windows/icon.ico

  dev:frontend:
    summary: Runs the frontend in development mode
    dir: ../frontend
    deps:
      - task: install:frontend:deps
    vars:
      # Backend port for Vite proxy.
      # Prefer explicit env VITE_BACKEND_PORT, then SERVER_PORT, then read from local.db (SERVER_PORT), else 8080.
      BACKEND_PORT:
        sh: |
          if [ -n "${VITE_BACKEND_PORT:-}" ]; then
            echo "${VITE_BACKEND_PORT}"
            exit 0
          fi
          if [ -n "${SERVER_PORT:-}" ]; then
            echo "${SERVER_PORT}"
            exit 0
          fi
          python3 - <<'PY'
          import os, sqlite3, pathlib
          base = os.path.expanduser(os.getenv("TWITCH_OVERLAY_DATA_DIR", "~/.twitch-overlay"))
          db = str(pathlib.Path(base) / "local.db")
          port = "8080"
          try:
            con = sqlite3.connect(db)
            cur = con.cursor()
            cur.execute("select value from settings where key='SERVER_PORT'")
            row = cur.fetchone()
            if row and row[0] and str(row[0]).strip():
              port = str(row[0]).strip()
          except Exception:
            pass
          print(port)
          PY
      # Wails dev sets FRONTEND_DEVSERVER_URL (e.g. http://localhost:9245).
      # Prefer explicit env VITE_PORT, otherwise derive from FRONTEND_DEVSERVER_URL, otherwise default.
      VITE_PORT:
        sh: |
          if [ -n "${VITE_PORT:-}" ]; then
            echo "${VITE_PORT}"
            exit 0
          fi
          if [ -n "${FRONTEND_DEVSERVER_URL:-}" ]; then
            echo "${FRONTEND_DEVSERVER_URL}" | sed -E 's#^https?://[^:]+:([0-9]+).*$#\\1#'
            exit 0
          fi
          echo 9245
    cmds:
      - VITE_BACKEND_PORT={{.BACKEND_PORT}} bun run dev -- --port {{.VITE_PORT}} --strictPort

  update:build-assets:
    summary: Updates the build assets
    cmds:
      - wails3 update build-assets -name "twitch-overlay" -binaryname "twitch-overlay" -config config.yml -dir .
