name: close-issues-on-develop-merge

on:
  pull_request:
    types: [closed]
    branches: [develop]

jobs:
  close-issues:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: read
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner
            const repo = context.repo.repo
            const pr = context.payload.pull_request
            const body = pr.body || ""

            const issueRefPattern = /\b(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+#(\d+)/gi
            const refs = [...body.matchAll(issueRefPattern)].map((m) => Number(m[1]))
            const issueNumbers = [...new Set(refs)]

            try {
              await github.rest.issues.getLabel({ owner, repo, name: "release:pending" })
            } catch (e) {
              if (e.status !== 404) throw e
              await github.rest.issues.createLabel({
                owner,
                repo,
                name: "release:pending",
                color: "BFD4F2",
                description: "Merged to develop but not yet released to main"
              })
            }

            let hasReferencedIssue = false
            for (const issue_number of issueNumbers) {
              const { data: issue } = await github.rest.issues.get({ owner, repo, issue_number })
              if (issue.pull_request) continue
              hasReferencedIssue = true
              if (issue.state === "open") {
                await github.rest.issues.update({ owner, repo, issue_number, state: "closed" })
              }
            }

            if (hasReferencedIssue) {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: pr.number,
                labels: ["release:pending"]
              })
            }
