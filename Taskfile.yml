version: "3"

tasks:
  # é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ä»˜ãï¼‰
  dev:
    desc: ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ä»˜ãé–‹ç™ºãƒ¢ãƒ¼ãƒ‰
    cmds:
      - |
        if [ -z "$SERVER_PORT" ]; then
          DB_PORT=$(sqlite3 "$HOME/.twitch-overlay/local.db" \
            "SELECT value FROM settings WHERE key='SERVER_PORT'" 2>/dev/null)
          export SERVER_PORT="${DB_PORT:-8080}"
        fi
        export VITE_BACKEND_PORT="$SERVER_PORT"
        echo "ğŸ“¦ web/dist ã‚’æº–å‚™ä¸­..."
        (cd web && bun run build)
        echo "ğŸ”¥ Overlayé–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ä¸­... (port 5174)"
        (cd web && bun run dev) &
        WEB_PID=$!
        trap "kill $WEB_PID 2>/dev/null" EXIT
        echo "ğŸš€ cargo tauri dev ã‚’èµ·å‹•ä¸­..."
        echo "   Backend:       http://localhost:$SERVER_PORT"
        echo "   Dashboard HMR: http://localhost:5173"
        echo "   Overlay HMR:   http://localhost:5174"
        cargo tauri dev

  dev:quick:
    desc: ã‚¯ã‚¤ãƒƒã‚¯é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯äº‹å‰ãƒ“ãƒ«ãƒ‰å‰æï¼‰
    cmds:
      - cargo run -p cairo-overlay --bin cairo-overlay-server

  # Tauriã‚¢ãƒ—ãƒªã¨ã—ã¦èµ·å‹•ï¼ˆã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ä»˜ãï¼‰
  dev:tauri:
    desc: Tauriãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚¢ãƒ—ãƒªã¨ã—ã¦èµ·å‹•
    cmds:
      - |
        echo "ğŸ“¦ OBSç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
        (cd web && bun run build)
        echo "ğŸ“¦ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
        (cd frontend && bun run build)
        echo "ğŸš€ cargo tauri dev ã‚’èµ·å‹•ä¸­..."
        cargo tauri dev

  # ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰
  build:
    desc: ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œ
    cmds:
      - echo "ğŸ“¦ OBSç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
      - cd web && bun run build
      - echo "ğŸ“¦ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
      - cd frontend && bun run build
      - echo "ğŸ”¨ Tauriã‚¢ãƒ—ãƒªã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
      - cargo tauri build
      - echo "âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†"

  # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  clean:
    desc: ãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    cmds:
      - echo "ãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
      - rm -rf src-tauri/target
      - rm -rf frontend/dist
      - rm -rf web/dist
      - echo "ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"

  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  test:
    desc: å…¨ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
    env:
      DRY_RUN_MODE: "true"
    cmds:
      - echo "ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
      - cargo test

  smoke:api:
    desc: APIã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆdevèµ·å‹•å¾Œï¼‰
    env:
      DRY_RUN_MODE: "true"
    cmds:
      - ./scripts/api_smoke.sh

  test:api:
    desc: APIäº’æ›ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆdevèµ·å‹•å¾Œï¼‰
    env:
      DRY_RUN_MODE: "true"
    cmds:
      - ./scripts/api_smoke.sh

  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  install:
    desc: å…¨ã¦ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    cmds:
      - echo "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
      - cd frontend && bun install
      - echo "Webã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
      - cd web && bun install
      - echo "ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"

  i:
    desc: å…¨ã¦ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆçŸ­ç¸®ç‰ˆï¼‰
    cmds:
      - task: install

  # ã‚¯ãƒªãƒ¼ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  ci:
    desc: node_modulesã‚’å‰Šé™¤ã—ã¦ã‚¯ãƒªãƒ¼ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    cmds:
      - echo "æ—¢å­˜ã®node_modulesã‚’å‰Šé™¤ä¸­..."
      - rm -rf frontend/node_modules web/node_modules
      - rm -f frontend/bun.lockb web/bun.lockb
      - echo "ã‚¯ãƒªãƒ¼ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Ÿè¡Œä¸­..."
      - cd frontend && bun install
      - cd web && bun install
      - echo "ã‚¯ãƒªãƒ¼ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"

  # ä¾å­˜é–¢ä¿‚ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
  update:
    desc: å…¨ã¦ã®ä¾å­˜é–¢ä¿‚ã‚’æœ€æ–°ç‰ˆã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
    cmds:
      - echo "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°ä¸­..."
      - cd frontend && bun update
      - echo "Webã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°ä¸­..."
      - cd web && bun update
      - echo "Rustä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°ä¸­..."
      - cargo update
      - echo "ä¾å­˜é–¢ä¿‚ã®æ›´æ–°å®Œäº†"
