version: "3"

tasks:
  # ÈñãÁô∫„É¢„Éº„Éâ
  dev:
    desc: ÈñãÁô∫„É¢„Éº„Éâ„Åß„Ç¢„Éó„É™„ÇíËµ∑ÂãïÔºàOBSÁî®„Ç™„Éº„Éê„Éº„É¨„Ç§„ÇÇÂêåÊôÇ„Éì„É´„ÉâÔºâ
    cmds:
      - |
        echo "üì¶ OBSÁî®„Ç™„Éº„Éê„Éº„É¨„Ç§„Çí„Éì„É´„Éâ‰∏≠..."
        (cd web && bun run build)

        echo "üì¶ „É™„É¢„Éº„Éà„Ç≥„É≥„Éà„É≠„Éº„É´UI„Çí„Éì„É´„Éâ‰∏≠..."
        (cd web/remote && bun install && bun run build)

        echo "üì¶ „Éï„É≠„É≥„Éà„Ç®„É≥„Éâ„Çí„Éì„É´„Éâ‰∏≠..."
        (cd frontend && bun run build)

        echo "üî® Go„Éê„Ç§„Éä„É™„Çí„Éì„É´„Éâ‰∏≠..."
        go build -o build/bin/twitch-overlay

        echo "üöÄ „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÇíËµ∑Âãï‰∏≠..."
        echo "üí° „Éï„É≠„É≥„Éà„Ç®„É≥„ÉâÂ§âÊõ¥ÊôÇ: Ctrl+C „ÅßÂÅúÊ≠¢ ‚Üí 'task dev' „ÅßÂÜçËµ∑Âãï"
        echo "üí° „Çà„ÇäÊó©„ÅÑÈñãÁô∫: 'task dev:quick' „Çí‰ΩøÁî®ÔºàGo„Éì„É´„Éâ„ÅÆ„ÅøÔºâ"
        ./build/bin/twitch-overlay

  # „ÇØ„Ç§„ÉÉ„ÇØÈñãÁô∫„É¢„Éº„ÉâÔºà„Éï„É≠„É≥„Éà„Ç®„É≥„Éâ„ÅØÊó¢„Å´„Éì„É´„ÉâÊ∏à„Åø„Å®‰ªÆÂÆöÔºâ
  dev:quick:
    desc: „ÇØ„Ç§„ÉÉ„ÇØÈñãÁô∫„É¢„Éº„ÉâÔºàGoÂÜç„Éì„É´„Éâ„ÅÆ„Åø„ÄÅ„Éï„É≠„É≥„Éà„Ç®„É≥„Éâ„Éì„É´„ÉâÊ∏à„ÅøÂâçÊèêÔºâ
    cmds:
      - |
        echo "üî® Go„Éê„Ç§„Éä„É™„Çí„Éì„É´„Éâ‰∏≠..."
        go build -o build/bin/twitch-overlay

        echo "üöÄ „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÇíËµ∑Âãï‰∏≠..."
        ./build/bin/twitch-overlay

  # „Éó„É≠„ÉÄ„ÇØ„Ç∑„Éß„É≥„Éì„É´„Éâ
  build:
    desc: „Éó„É≠„ÉÄ„ÇØ„Ç∑„Éß„É≥„Éì„É´„Éâ„ÇíÂÆüË°å
    cmds:
      - echo "OBSÁî®„Ç™„Éº„Éê„Éº„É¨„Ç§„Çí„Éì„É´„Éâ‰∏≠..."
      - cd web && bun run build
      - echo "„É™„É¢„Éº„Éà„Ç≥„É≥„Éà„É≠„Éº„É´UI„Çí„Éì„É´„Éâ‰∏≠..."
      - cd web/remote && bun install && bun run build
      - echo "„Éï„É≠„É≥„Éà„Ç®„É≥„Éâ‰æùÂ≠òÈñ¢‰øÇ„Çí„Ç§„É≥„Çπ„Éà„Éº„É´‰∏≠..."
      - cd frontend && bun install
      - echo "mic-recog„Çí„Éì„É´„Éâ‰∏≠..."
      - task: mic-recog:build
      - echo "„Éê„Ç§„É≥„Éá„Ç£„É≥„Ç∞ÁîüÊàê‰∏≠..."
      - wails3 generate bindings -clean=true
      - echo "„Éï„É≠„É≥„Éà„Ç®„É≥„Éâ„Çí„Éì„É´„Éâ‰∏≠..."
      - cd frontend && bun run build
      - echo ".app„Éê„É≥„Éâ„É´„Çí‰ΩúÊàê‰∏≠..."
      - mkdir -p build/bin/twitch-overlay.app/Contents/MacOS
      - mkdir -p build/bin/twitch-overlay.app/Contents/Resources
      - echo "Go„Éê„Ç§„Éä„É™„Çí„Éì„É´„Éâ‰∏≠..."
      - go build -tags production -ldflags "-w -s" -o build/bin/twitch-overlay.app/Contents/MacOS/twitch-overlay
      - echo "Info.plist„Çí„Ç≥„Éî„Éº‰∏≠..."
      - cp build/darwin/Info.plist build/bin/twitch-overlay.app/Contents/
      - echo "mic-recog„ÇíÂêåÊ¢±‰∏≠..."
      - task: mic-recog:bundle
      - echo "ÁΩ≤ÂêçÂá¶ÁêÜ‰∏≠Ôºà„Ç®„É≥„Çø„Ç§„Éà„É´„É°„É≥„ÉàÈÅ©Áî®Ôºâ..."
      - codesign --force --deep --sign - --entitlements build/darwin/entitlements.plist build/bin/twitch-overlay.app
      - echo "„Éì„É´„ÉâÂÆå‰∫Ü ‚Üí build/bin/twitch-overlay.app"

  # „Éá„Éê„ÉÉ„Ç∞„Éì„É´„Éâ
  build:debug:
    desc: „Éá„Éê„ÉÉ„Ç∞„Éì„É´„Éâ„ÇíÂÆüË°å
    cmds:
      - echo "OBSÁî®„Ç™„Éº„Éê„Éº„É¨„Ç§„Çí„Éì„É´„Éâ‰∏≠..."
      - cd web && bun run build
      - echo "„Éï„É≠„É≥„Éà„Ç®„É≥„Éâ‰æùÂ≠òÈñ¢‰øÇ„Çí„Ç§„É≥„Çπ„Éà„Éº„É´‰∏≠..."
      - cd frontend && bun install
      - echo "„Éê„Ç§„É≥„Éá„Ç£„É≥„Ç∞ÁîüÊàê‰∏≠..."
      - wails3 generate bindings -clean=true
      - echo "„Éï„É≠„É≥„Éà„Ç®„É≥„Éâ„Çí„Éì„É´„Éâ‰∏≠Ôºà„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÔºâ..."
      - cd frontend && bun run build:dev
      - echo "Go„Éê„Ç§„Éä„É™„Çí„Éì„É´„Éâ‰∏≠Ôºà„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÔºâ..."
      - go build -tags debug -o build/bin/twitch-overlay
      - echo "ÁΩ≤ÂêçÂá¶ÁêÜ‰∏≠Ôºà„Ç®„É≥„Çø„Ç§„Éà„É´„É°„É≥„ÉàÈÅ©Áî®Ôºâ..."
      - codesign --force --sign - --entitlements build/darwin/entitlements.plist build/bin/twitch-overlay
      - echo "„Éá„Éê„ÉÉ„Ç∞„Éì„É´„ÉâÂÆå‰∫Ü ‚Üí build/bin/"

  # „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
  clean:
    desc: „Éì„É´„Éâ„Éï„Ç°„Ç§„É´„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
    cmds:
      - echo "„Éì„É´„Éâ„Éï„Ç°„Ç§„É´„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó‰∏≠..."
      - rm -rf build/bin
      - rm -rf frontend/dist
      - echo "„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü"

  # „Éì„É´„ÉâÊ∏à„Åø„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÇíÂÆüË°å
  run:
    desc: „Éì„É´„ÉâÊ∏à„Åø„ÅÆ„Ç¢„Éó„É™„ÇíÂÆüË°å
    cmds:
      - |
        if [ -f build/bin/twitch-overlay.app/Contents/MacOS/twitch-overlay ]; then
          open build/bin/twitch-overlay.app
        else
          echo "„Ç®„É©„Éº: „Éì„É´„ÉâÊ∏à„Åø„Ç¢„Éó„É™„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì"
          echo "ÂÖà„Å´ 'task build' „Åß„Éì„É´„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
          exit 1
        fi

  # „ÉÜ„Çπ„ÉàÂÆüË°å
  test:
    desc: ÂÖ®„ÉÜ„Çπ„Éà„ÇíÂÆüË°å
    env:
      DRY_RUN_MODE: "true"
    cmds:
      - echo "„ÉÜ„Çπ„Éà„ÇíÂÆüË°å‰∏≠..."
      - go test ./...

  # ÈÖçÂ∏ÉÁî®„Éë„ÉÉ„Ç±„Éº„Ç∏‰ΩúÊàêÔºàmacOSÔºâ
  pkg:
    desc: ÈÖçÂ∏ÉÁî®„Éë„ÉÉ„Ç±„Éº„Ç∏„Çí‰ΩúÊàê
    deps: [build]
    cmds:
      - echo "ÈÖçÂ∏ÉÁî®„Éë„ÉÉ„Ç±„Éº„Ç∏„Çí‰ΩúÊàê‰∏≠..."
      - |
        if [ "$(uname)" = "Darwin" ]; then
          echo "macOSÁî®„ÅÆDMG„Çí‰ΩúÊàê‰∏≠..."
          # DMG‰ΩúÊàê„Ç≥„Éû„É≥„ÉâÔºàË¶ÅËøΩÂä†Ôºâ
          echo "TODO: DMG‰ΩúÊàêÂÆüË£Ö"
        else
          echo "ÁèæÂú®„ÅÆ„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†„Åß„ÅØ„Éë„ÉÉ„Ç±„Éº„Ç∏‰ΩúÊàêÊú™ÂØæÂøú"
        fi

  # „Éï„É≠„É≥„Éà„Ç®„É≥„Éâ‰æùÂ≠òÈñ¢‰øÇ„Ç§„É≥„Çπ„Éà„Éº„É´
  frontend:install:
    desc: „Éï„É≠„É≥„Éà„Ç®„É≥„Éâ„ÅÆ‰æùÂ≠òÈñ¢‰øÇ„Çí„Ç§„É≥„Çπ„Éà„Éº„É´
    dir: frontend
    cmds:
      - bun install

  # ‰æùÂ≠òÈñ¢‰øÇ„ÅÆ‰∏ÄÊã¨„Ç§„É≥„Çπ„Éà„Éº„É´
  install:
    desc: ÂÖ®„Å¶„ÅÆ‰æùÂ≠òÈñ¢‰øÇ„Çí„Ç§„É≥„Çπ„Éà„Éº„É´
    cmds:
      - echo "„Éï„É≠„É≥„Éà„Ç®„É≥„Éâ„ÅÆ‰æùÂ≠òÈñ¢‰øÇ„Çí„Ç§„É≥„Çπ„Éà„Éº„É´‰∏≠..."
      - cd frontend && bun install
      - echo "Web„Ç™„Éº„Éê„Éº„É¨„Ç§„ÅÆ‰æùÂ≠òÈñ¢‰øÇ„Çí„Ç§„É≥„Çπ„Éà„Éº„É´‰∏≠..."
      - cd web && bun install
      - echo "‰æùÂ≠òÈñ¢‰øÇ„ÅÆ„Ç§„É≥„Çπ„Éà„Éº„É´ÂÆå‰∫Ü"

  # Áü≠Á∏Æ„Ç≥„Éû„É≥„Éâ
  i:
    desc: ÂÖ®„Å¶„ÅÆ‰æùÂ≠òÈñ¢‰øÇ„Çí„Ç§„É≥„Çπ„Éà„Éº„É´ÔºàÁü≠Á∏ÆÁâàÔºâ
    cmds:
      - task: install

  # „ÇØ„É™„Éº„É≥„Ç§„É≥„Çπ„Éà„Éº„É´
  ci:
    desc: node_modules„ÇíÂâäÈô§„Åó„Å¶„ÇØ„É™„Éº„É≥„Ç§„É≥„Çπ„Éà„Éº„É´
    cmds:
      - echo "Êó¢Â≠ò„ÅÆnode_modules„ÇíÂâäÈô§‰∏≠..."
      - rm -rf frontend/node_modules web/node_modules
      - echo "bun.lockb„ÇíÂâäÈô§‰∏≠..."
      - rm -f frontend/bun.lockb web/bun.lockb
      - echo "„ÇØ„É™„Éº„É≥„Ç§„É≥„Çπ„Éà„Éº„É´ÂÆüË°å‰∏≠..."
      - cd frontend && bun install
      - cd web && bun install
      - echo "„ÇØ„É™„Éº„É≥„Ç§„É≥„Çπ„Éà„Éº„É´ÂÆå‰∫Ü"

  # ‰æùÂ≠òÈñ¢‰øÇ„ÅÆ„Ç¢„ÉÉ„Éó„Éá„Éº„Éà
  update:
    desc: ÂÖ®„Å¶„ÅÆ‰æùÂ≠òÈñ¢‰øÇ„ÇíÊúÄÊñ∞Áâà„Å´„Ç¢„ÉÉ„Éó„Éá„Éº„Éà
    cmds:
      - echo "„Éï„É≠„É≥„Éà„Ç®„É≥„Éâ„ÅÆ‰æùÂ≠òÈñ¢‰øÇ„ÇíÊõ¥Êñ∞‰∏≠..."
      - cd frontend && bun update
      - echo "Web„Ç™„Éº„Éê„Éº„É¨„Ç§„ÅÆ‰æùÂ≠òÈñ¢‰øÇ„ÇíÊõ¥Êñ∞‰∏≠..."
      - cd web && bun update
      - echo "‰æùÂ≠òÈñ¢‰øÇ„ÅÆÊõ¥Êñ∞ÂÆå‰∫Ü"

  # ‰æùÂ≠òÈñ¢‰øÇ„ÅÆÁ¢∫Ë™ç
  deps:
    desc: „Ç§„É≥„Çπ„Éà„Éº„É´Ê∏à„Åø„ÅÆ‰æùÂ≠òÈñ¢‰øÇ„ÇíÁ¢∫Ë™ç
    cmds:
      - echo "=== Frontend Dependencies ==="
      - cd frontend && bun pm ls
      - echo ""
      - echo "=== Web Dependencies ==="
      - cd web && bun pm ls

  # ClaudeËµ∑Âãï
  claude:
    desc: ClaudeËµ∑Âãï
    cmds:
      - claude --dangerously-skip-permissions

  # „Éê„Éº„Ç∏„Éß„É≥ÊÉÖÂ†±Ë°®Á§∫
  version:
    desc: „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÅÆ„Éê„Éº„Ç∏„Éß„É≥ÊÉÖÂ†±„ÇíË°®Á§∫
    cmds:
      - |
        if [ -f build/bin/twitch-overlay.app/Contents/MacOS/twitch-overlay ]; then
          ./build/bin/twitch-overlay.app/Contents/MacOS/twitch-overlay --version
        else
          echo "„Éê„Éº„Ç∏„Éß„É≥: ÈñãÁô∫Áâà"
        fi

  mic-recog:build:
    desc: mic-recog „ÇíPyInstaller„Åß„Éì„É´„Éâ
    dir: mic-recog
    cmds:
      - ./build.sh mic_stream

  mic-recog:venv:
    desc: mic-recog „ÅÆvenv‰ΩúÊàê„Å®‰æùÂ≠ò„Ç§„É≥„Çπ„Éà„Éº„É´
    cmds:
      - |
        if command -v python3 >/dev/null 2>&1; then
          PYTHON_BIN=python3
        elif command -v python >/dev/null 2>&1; then
          PYTHON_BIN=python
        else
          echo "Python„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì"
          exit 1
        fi
        "$PYTHON_BIN" -m venv mic-recog/.venv
        mic-recog/.venv/bin/python -m pip install -r mic-recog/requirements.txt

  mic-recog:bundle:
    desc: mic-recog „Çí .app „Å´ÂêåÊ¢±
    cmds:
      - mkdir -p build/bin/twitch-overlay.app/Contents/Resources/mic-recog
      - rsync -av --delete --exclude '__pycache__' --exclude '.venv' --exclude 'build' --exclude '*.spec' mic-recog/ build/bin/twitch-overlay.app/Contents/Resources/mic-recog/
