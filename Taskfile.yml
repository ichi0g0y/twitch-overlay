version: "3"

tasks:
  # é–‹ç™ºãƒ¢ãƒ¼ãƒ‰
  dev:
    desc: é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ï¼ˆOBSç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚‚åŒæ™‚ãƒ“ãƒ«ãƒ‰ï¼‰
    cmds:
      - |
        echo "ğŸ“¦ OBSç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
        (cd web && bun run build)

        echo "ğŸ“¦ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
        (cd frontend && bun run build)

        echo "ğŸ”¨ Goãƒã‚¤ãƒŠãƒªã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
        go build -o build/bin/twitch-overlay

        echo "ğŸš€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ä¸­..."
        echo "ğŸ’¡ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å¤‰æ›´æ™‚: Ctrl+C ã§åœæ­¢ â†’ 'task dev' ã§å†èµ·å‹•"
        echo "ğŸ’¡ ã‚ˆã‚Šæ—©ã„é–‹ç™º: 'task dev:quick' ã‚’ä½¿ç”¨ï¼ˆGoãƒ“ãƒ«ãƒ‰ã®ã¿ï¼‰"
        ./build/bin/twitch-overlay

  # ã‚¯ã‚¤ãƒƒã‚¯é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯æ—¢ã«ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ã¨ä»®å®šï¼‰
  dev:quick:
    desc: ã‚¯ã‚¤ãƒƒã‚¯é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ï¼ˆGoå†ãƒ“ãƒ«ãƒ‰ã®ã¿ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰æ¸ˆã¿å‰æï¼‰
    cmds:
      - |
        echo "ğŸ”¨ Goãƒã‚¤ãƒŠãƒªã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
        go build -o build/bin/twitch-overlay

        echo "ğŸš€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ä¸­..."
        ./build/bin/twitch-overlay

  # ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰
  build:
    desc: ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œ
    cmds:
      - echo "OBSç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
      - cd web && bun run build
      - echo "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
      - cd frontend && bun install
      - echo "ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ç”Ÿæˆä¸­..."
      - wails3 generate bindings -clean=true
      - echo "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
      - cd frontend && bun run build
      - echo ".appãƒãƒ³ãƒ‰ãƒ«ã‚’ä½œæˆä¸­..."
      - mkdir -p build/bin/twitch-overlay.app/Contents/MacOS
      - mkdir -p build/bin/twitch-overlay.app/Contents/Resources
      - echo "Goãƒã‚¤ãƒŠãƒªã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
      - go build -tags production -ldflags "-w -s" -o build/bin/twitch-overlay.app/Contents/MacOS/twitch-overlay
      - echo "Info.plistã‚’ã‚³ãƒ”ãƒ¼ä¸­..."
      - cp build/darwin/Info.plist build/bin/twitch-overlay.app/Contents/
      - echo "ç½²åå‡¦ç†ä¸­ï¼ˆã‚¨ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ãƒ¡ãƒ³ãƒˆé©ç”¨ï¼‰..."
      - codesign --force --deep --sign - --entitlements build/darwin/entitlements.plist build/bin/twitch-overlay.app
      - echo "ãƒ“ãƒ«ãƒ‰å®Œäº† â†’ build/bin/twitch-overlay.app"

  # ãƒ‡ãƒãƒƒã‚°ãƒ“ãƒ«ãƒ‰
  build:debug:
    desc: ãƒ‡ãƒãƒƒã‚°ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œ
    cmds:
      - echo "OBSç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
      - cd web && bun run build
      - echo "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
      - cd frontend && bun install
      - echo "ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ç”Ÿæˆä¸­..."
      - wails3 generate bindings -clean=true
      - echo "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ä¸­ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ï¼‰..."
      - cd frontend && bun run build:dev
      - echo "Goãƒã‚¤ãƒŠãƒªã‚’ãƒ“ãƒ«ãƒ‰ä¸­ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ï¼‰..."
      - go build -tags debug -o build/bin/twitch-overlay
      - echo "ç½²åå‡¦ç†ä¸­ï¼ˆã‚¨ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ãƒ¡ãƒ³ãƒˆé©ç”¨ï¼‰..."
      - codesign --force --sign - --entitlements build/darwin/entitlements.plist build/bin/twitch-overlay
      - echo "ãƒ‡ãƒãƒƒã‚°ãƒ“ãƒ«ãƒ‰å®Œäº† â†’ build/bin/"

  # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  clean:
    desc: ãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    cmds:
      - echo "ãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
      - rm -rf build/bin
      - rm -rf frontend/dist
      - echo "ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"

  # ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
  run:
    desc: ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ã®ã‚¢ãƒ—ãƒªã‚’å®Ÿè¡Œ
    cmds:
      - |
        if [ -f build/bin/twitch-overlay.app/Contents/MacOS/twitch-overlay ]; then
          open build/bin/twitch-overlay.app
        else
          echo "ã‚¨ãƒ©ãƒ¼: ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ã‚¢ãƒ—ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          echo "å…ˆã« 'task build' ã§ãƒ“ãƒ«ãƒ‰ã—ã¦ãã ã•ã„"
          exit 1
        fi

  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  test:
    desc: å…¨ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
    env:
      DRY_RUN_MODE: "true"
    cmds:
      - echo "ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
      - go test ./...

  # é…å¸ƒç”¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆï¼ˆmacOSï¼‰
  pkg:
    desc: é…å¸ƒç”¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½œæˆ
    deps: [build]
    cmds:
      - echo "é…å¸ƒç”¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½œæˆä¸­..."
      - |
        if [ "$(uname)" = "Darwin" ]; then
          echo "macOSç”¨ã®DMGã‚’ä½œæˆä¸­..."
          # DMGä½œæˆã‚³ãƒãƒ³ãƒ‰ï¼ˆè¦è¿½åŠ ï¼‰
          echo "TODO: DMGä½œæˆå®Ÿè£…"
        else
          echo "ç¾åœ¨ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã¯ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆæœªå¯¾å¿œ"
        fi

  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  frontend:install:
    desc: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    dir: frontend
    cmds:
      - bun install

  # ä¾å­˜é–¢ä¿‚ã®ä¸€æ‹¬ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  install:
    desc: å…¨ã¦ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    cmds:
      - echo "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
      - cd frontend && bun install
      - echo "Webã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
      - cd web && bun install
      - echo "ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"

  # çŸ­ç¸®ã‚³ãƒãƒ³ãƒ‰
  i:
    desc: å…¨ã¦ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆçŸ­ç¸®ç‰ˆï¼‰
    cmds:
      - task: install

  # ã‚¯ãƒªãƒ¼ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  ci:
    desc: node_modulesã‚’å‰Šé™¤ã—ã¦ã‚¯ãƒªãƒ¼ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    cmds:
      - echo "æ—¢å­˜ã®node_modulesã‚’å‰Šé™¤ä¸­..."
      - rm -rf frontend/node_modules web/node_modules
      - echo "bun.lockbã‚’å‰Šé™¤ä¸­..."
      - rm -f frontend/bun.lockb web/bun.lockb
      - echo "ã‚¯ãƒªãƒ¼ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Ÿè¡Œä¸­..."
      - cd frontend && bun install
      - cd web && bun install
      - echo "ã‚¯ãƒªãƒ¼ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"

  # ä¾å­˜é–¢ä¿‚ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
  update:
    desc: å…¨ã¦ã®ä¾å­˜é–¢ä¿‚ã‚’æœ€æ–°ç‰ˆã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
    cmds:
      - echo "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°ä¸­..."
      - cd frontend && bun update
      - echo "Webã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°ä¸­..."
      - cd web && bun update
      - echo "ä¾å­˜é–¢ä¿‚ã®æ›´æ–°å®Œäº†"

  # ä¾å­˜é–¢ä¿‚ã®ç¢ºèª
  deps:
    desc: ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã®ä¾å­˜é–¢ä¿‚ã‚’ç¢ºèª
    cmds:
      - echo "=== Frontend Dependencies ==="
      - cd frontend && bun pm ls
      - echo ""
      - echo "=== Web Dependencies ==="
      - cd web && bun pm ls

  # Claudeèµ·å‹•
  claude:
    desc: Claudeèµ·å‹•
    cmds:
      - claude --dangerously-skip-permissions

  # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±è¡¨ç¤º
  version:
    desc: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’è¡¨ç¤º
    cmds:
      - |
        if [ -f build/bin/twitch-overlay.app/Contents/MacOS/twitch-overlay ]; then
          ./build/bin/twitch-overlay.app/Contents/MacOS/twitch-overlay --version
        else
          echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³: é–‹ç™ºç‰ˆ"
        fi
